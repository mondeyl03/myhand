<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Exoesqueleto de los Timbritos</title>
<style>
  body { font-family: Arial, sans-serif; background: #0d1117; color: #e6eef6; text-align: center; margin: 0; padding: 0; }
  h1 { background: #06b6d4; color: #0d1117; padding: 10px; margin: 0; }
  .container { margin: 20px auto; max-width: 400px; background: #161b22; padding: 20px; border-radius: 10px; }
  .finger { margin: 15px 0; padding: 10px; border: 1px solid #06b6d4; border-radius: 8px; display: flex; align-items: center; justify-content: space-between; }
  .finger label { font-weight: bold; display: block; margin-bottom: 5px; }
  input[type=range] { width: 65%; }
  .value { font-size: 0.9em; color: #94a3b8; width: 35px; display: inline-block; text-align: right; }
  .btn { margin: 5px; padding: 10px 15px; background: #06b6d4; border: none; color: #0d1117; border-radius: 8px; cursor: pointer; font-weight: bold; }
  .btn.secondary { background: transparent; border: 1px solid #06b6d4; color: #06b6d4; }
  .control-buttons { margin-top: 10px; }
  .mic-button { margin: 10px; padding: 10px; background: #facc15; border: none; border-radius: 50%; cursor: pointer; font-weight: bold; }
  #commandBox { margin-top:10px; font-size: 1em; color: #facc15; min-height: 20px; }
  .hook-btn { margin-left: 5px; padding: 5px 8px; font-size: 0.8em; cursor: pointer; border-radius: 5px; border: 1px solid #06b6d4; background: transparent; color: #06b6d4; }
</style>
</head>
<body>

<h1>Exoesqueleto de los Timbritos</h1>

<div class="container" id="sliders"></div>

<div class="control-buttons">
  <button class="btn" onclick="setAll(90)">Abrir Mano</button>
  <button class="btn" onclick="setAll(0)">Cerrar Mano</button>
</div>

<button class="mic-button" onclick="startVoice()">üé§</button>
<div id="commandBox"></div>

<script>
const fingerNames = ["Me√±ique","Anular","Coraz√≥n","√çndice","Pulgar"];
let positions = [90,90,90,90,90];
let lastSaved = [90,90,90,90,90];
const slidersDiv = document.getElementById('sliders');

for(let i=0;i<5;i++){
  const cont = document.createElement('div');
  cont.className = 'finger';
  cont.innerHTML = `
    <label>${fingerNames[i]} ‚Äî <span class="value" id="val${i}">${positions[i]}</span>¬∞</label>
    <input type="range" min="0" max="90" value="${positions[i]}" id="s${i}" 
      oninput="manualMove(${i},this.value)">
    <button class="hook-btn" onclick="regresarAnterior(${i})">‚Ü∫</button>
  `;
  slidersDiv.appendChild(cont);
}

function manualMove(idx,val){
  val=parseInt(val);
  positions[idx]=val;
  document.getElementById('val'+idx).textContent=val;
  fetch(`/servo?finger=${idx}&value=${val}`).catch(()=>{});
}

function setAll(angle){
  for(let i=0;i<5;i++){
    moveToAngle(i,angle);
  }
}

function regresarAnterior(idx){
  moveToAngle(idx,lastSaved[idx]);
}

// movimiento gradual en pasos de 3¬∞
function moveToAngle(idx,target){
  lastSaved[idx]=positions[idx]; // guardamos valor anterior
  let current = positions[idx];
  let step = target>current?3:-3;
  let interval = setInterval(()=>{
    current += step;
    if((step>0 && current>=target) || (step<0 && current<=target)){
      current=target;
      clearInterval(interval);
    }
    positions[idx]=current;
    document.getElementById('s'+idx).value=current;
    document.getElementById('val'+idx).textContent=current;
    fetch(`/servo?finger=${idx}&value=${current}`).catch(()=>{});
  },100); // 100ms = 0.1s entre pasos -> suaviza el movimiento
}

// ===== Comando de voz =====
function startVoice(){
  const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
  recognition.lang = 'es-ES';
  recognition.start();
  recognition.onresult=function(event){
    let text=event.results[0][0].transcript.toLowerCase().trim();
    document.getElementById('commandBox').textContent='Comando detectado: '+text;

    // ABRIR MANO / CERRAR MANO
    if(text.includes('abrir mano')) setAll(90);
    else if(text.includes('cerrar mano')) setAll(0);

    // Dedo espec√≠fico: "me√±ique a 45"
    else{
      for(let i=0;i<5;i++){
        let name=fingerNames[i].toLowerCase();
        if(text.includes(name) && text.match(/\d+/)){
          let val = parseInt(text.match(/\d+/)[0]);
          val=Math.min(Math.max(0,val),90);
          moveToAngle(i,val);
        }
      }
    }
  };
  recognition.onerror=function(e){ console.log('Error reconocimiento',e); };
}
</script>

</body>
</html>
