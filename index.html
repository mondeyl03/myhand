<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Exoesqueleto de los Timbritos</title>
<style>
body { font-family: 'Trebuchet MS', sans-serif; background: #0d1117; color: #e6eef6; text-align: center; margin: 0; padding: 0; }
h1 { background: #06b6d4; color: #0d1117; padding: 15px; font-size: 2em; margin: 0; display:flex; justify-content:center; align-items:center; gap:15px; }
h1 img { height:50px; }
.container { margin: 20px auto; max-width: 550px; background: #161b22; padding: 25px; border-radius: 12px; }
.finger { margin: 15px 0; padding: 10px; border: 2px solid #06b6d4; border-radius: 10px; display: flex; align-items: center; justify-content: space-between; gap:5px; }
.finger label { font-weight: bold; min-width: 120px; text-align: left; display:flex; justify-content:space-between; }
input[type=range] { width: 150px; height: 18px; }
.value { font-size: 1em; color: #94a3b8; width: 40px; text-align: right; }
.btn { margin: 5px; padding: 12px 18px; border-radius: 12px; cursor:pointer; font-weight:bold; font-size:1em; }
.btn.openclose { background: #06b6d4; color: #0d1117; border:none; }
.btn.pause { background: #dc2626; color:white; border:none; }
.btn.micro { background: #16a34a; color:white; border:none; border-radius:50%; font-size:1.3em; width:50px; height:50px; }
.btn.arrow { background: #c0c0c0; color: #0d1117; border:none; width:35px; font-size:1.2em; }
#commandBox { margin-top:15px; font-size:1.2em; color:#16a34a; min-height:24px; font-weight:bold; }
</style>
</head>
<body>

<h1>
  Exoesqueleto de los Timbritos
  <img src="ExoHand.png" alt="Logo">
</h1>

<div class="container" id="sliders"></div>

<div style="margin-top:15px;">
  <button class="btn openclose" onclick="startAll(90)">Abrir Mano</button>
  <button class="btn openclose" onclick="startAll(0)">Cerrar Mano</button>
</div>

<button class="btn micro" onclick="startVoice()">üé§</button>
<div id="commandBox"></div>

<script>
const fingerNames = ["Me√±ique","Anular","Coraz√≥n","√çndice","Pulgar"];
let positions = [90,90,90,90,90];
let lastSaved = [90,90,90,90,90];
let intervals = [null,null,null,null,null];  
const slidersDiv = document.getElementById('sliders');

for(let i=0;i<5;i++){
  const cont = document.createElement('div');
  cont.className='finger';
  cont.innerHTML=`
    <label>${fingerNames[i]} ‚Äî <span class="value" id="val${i}">${positions[i]}</span>¬∞</label>
    <button class="btn arrow" onclick="stepFinger(${i},-1)">‚óÄ</button>
    <input type="range" min="0" max="90" value="${positions[i]}" id="s${i}" oninput="manualMove(${i},this.value)">
    <button class="btn arrow" onclick="stepFinger(${i},1)">‚ñ∂</button>
    <button class="btn pause" onclick="regresarAnterior(${i})">‚Ü∫</button>
    <button class="btn pause" onclick="pauseFinger(${i})">‚è∏</button>
  `;
  slidersDiv.appendChild(cont);
}

function manualMove(idx,val){
  val=parseInt(val);
  positions[idx]=val;
  document.getElementById('val'+idx).textContent=val;
  document.getElementById('s'+idx).value=val;
  fetch(`/servo?finger=${idx}&value=${val}`).catch(()=>{});
}

function stepFinger(idx,direction){
  let target = positions[idx] + direction;
  target = Math.max(0,Math.min(90,target));
  manualMove(idx,target);
}

function pauseFinger(idx){
  if(intervals[idx]) clearInterval(intervals[idx]);
  intervals[idx]=null;
}

function startAll(angle){
  for(let i=0;i<5;i++) moveToAngle(i,angle);
}

function regresarAnterior(idx){
  moveToAngle(idx,lastSaved[idx]);
}

function moveToAngle(idx,target){
  pauseFinger(idx);
  lastSaved[idx]=positions[idx]; 
  let current = positions[idx];
  let step = (target>current?3:-3);
  if(current===target) return;
  intervals[idx]=setInterval(()=>{
    current+=step;
    if((step>0 && current>=target) || (step<0 && current<=target)){
      current=target;
      clearInterval(intervals[idx]);
      intervals[idx]=null;
    }
    positions[idx]=current;
    document.getElementById('s'+idx).value=current;
    document.getElementById('val'+idx).textContent=current;
    fetch(`/servo?finger=${idx}&value=${current}`).catch(()=>{});
  },2000);
}

// Reconocimiento de voz b√°sico
function startVoice(){
  const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
  recognition.lang='es-ES';
  recognition.start();
  recognition.onresult=function(event){
    let text=event.results[0][0].transcript.toLowerCase().trim();
    document.getElementById('commandBox').textContent='Comando detectado: '+text;

    if(text.includes('pausar')){
      for(let i=0;i<5;i++){
        let name=fingerNames[i].toLowerCase();
        if(text.includes(name)) pauseFinger(i);
      }
      return;
    }

    if(text.includes('abrir mano')) startAll(90);
    else if(text.includes('cerrar mano')) startAll(0);
    else{
      for(let i=0;i<5;i++){
        let name=fingerNames[i].toLowerCase();
        if(text.includes(name) && text.match(/\d+/)){
          let val=parseInt(text.match(/\d+/)[0]);
          val=Math.min(Math.max(0,val),90);
          moveToAngle(i,val);
        }
      }
    }
  };
  recognition.onerror=function(e){ console.log('Error reconocimiento',e); };
}
</script>

</body>
</html>
