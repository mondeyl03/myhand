<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Exoesqueleto de los Timbritos</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #0d1117;
    color: #e6eef6;
    text-align: center;
    margin: 0;
    padding: 0;
  }
  h1 {
    background: #06b6d4;
    color: #0d1117;
    padding: 10px;
    margin: 0;
  }
  .container {
    margin: 20px auto;
    max-width: 420px;
    background: #161b22;
    padding: 20px;
    border-radius: 10px;
  }
  .finger {
    margin: 15px 0;
    padding: 10px;
    border: 1px solid #06b6d4;
    border-radius: 8px;
  }
  .finger label {
    font-weight: bold;
    display: block;
    margin-bottom: 5px;
  }
  input[type=range] { width: 70%; }
  .btn {
    margin: 8px;
    padding: 10px 15px;
    background: #06b6d4;
    border: none;
    color: #0d1117;
    border-radius: 8px;
    cursor: pointer;
    font-weight: bold;
  }
  .btn.secondary {
    background: transparent;
    border: 1px solid #06b6d4;
    color: #06b6d4;
  }
  .controls { margin-top: 15px; }
  .fine { margin-left: 4px; padding: 2px 7px; }
  .bottom-buttons {
    display: flex; justify-content: center; flex-wrap: wrap; gap: 6px; margin-top: 15px;
  }
</style>
</head>
<body>
<h1>Exoesqueleto de los Timbritos</h1>

<div class="container" id="sliders"></div>

<div class="controls">
  <button class="btn" onclick="openHand()">Abrir Mano</button>
  <button class="btn" onclick="closeHand()">Cerrar Mano</button>
  <button class="btn secondary" onclick="pauseAll()">Pausa</button>
  <button class="btn" onclick="startVoice()">üé§ Activar Micr√≥fono</button>
</div>

<h3>Regresar al √°ngulo anterior</h3>
<div class="bottom-buttons" id="prevButtons"></div>

<script>
const fingerNames = ["Me√±ique","Anular","Coraz√≥n","√çndice","Pulgar"];
let positions = [90,90,90,90,90];
let previous = [90,90,90,90,90];
let paused = false;
let moving = [false,false,false,false,false];
const ip = ""; // usa vac√≠o si est√° en el mismo WiFi

const slidersDiv = document.getElementById('sliders');
const prevButtons = document.getElementById('prevButtons');

/* Crear sliders */
for (let i=0;i<5;i++){
  const cont=document.createElement('div');
  cont.className='finger';
  cont.innerHTML=`
    <label>${fingerNames[i]} ‚Äî <span id="val${i}">${positions[i]}¬∞</span></label>
    <button class="fine" onclick="adjust(${i},-1)">‚óÑ</button>
    <input type="range" min="0" max="90" value="${positions[i]}" id="s${i}" oninput="onSlide(${i},this.value)">
    <button class="fine" onclick="adjust(${i},1)">‚ñ∫</button>
  `;
  slidersDiv.appendChild(cont);

  const pb=document.createElement('button');
  pb.className='btn secondary';
  pb.textContent=fingerNames[i];
  pb.onclick=()=>restorePrev(i);
  prevButtons.appendChild(pb);
}

/* Slider */
function onSlide(i,val){
  previous[i]=positions[i];
  positions[i]=parseFloat(val);
  document.getElementById('val'+i).textContent=val+'¬∞';
  fetch(`${ip}/servo?finger=${i}&value=${val}`).catch(()=>{});
}

/* Ajuste fino */
function adjust(i,dir){
  let val = positions[i]+dir;
  if(val<0) val=0; if(val>90) val=90;
  document.getElementById('s'+i).value=val;
  onSlide(i,val);
}

/* Restaurar anterior */
function restorePrev(i){
  const temp=positions[i];
  positions[i]=previous[i];
  previous[i]=temp;
  document.getElementById('s'+i).value=positions[i];
  onSlide(i,positions[i]);
}

/* Pausa */
function pauseAll(){ paused=!paused; alert(paused?"Movimiento pausado":"Reanudado"); }

/* Movimiento gradual */
function gradualMove(targets){
  const step=3;
  const interval=setInterval(()=>{
    let done=true;
    for(let i=0;i<5;i++){
      if(moving[i]) continue;
      let cur=positions[i];
      let tgt=targets[i];
      if(paused) return;
      if(Math.abs(cur-tgt)>0.5){
        done=false;
        previous[i]=cur;
        if(cur<tgt) cur=Math.min(cur+step,tgt);
        else cur=Math.max(cur-step,tgt);
        positions[i]=cur;
        document.getElementById('s'+i).value=cur;
        document.getElementById('val'+i).textContent=Math.round(cur)+'¬∞';
        fetch(`${ip}/servo?finger=${i}&value=${cur}`).catch(()=>{});
      }
    }
    if(done) clearInterval(interval);
  },2000);
}

/* Abrir/Cerrar */
function openHand(){ gradualMove([90,90,90,90,90]); }
function closeHand(){ gradualMove([0,0,0,0,0]); }

/* Voz */
function startVoice(){
  if(!('webkitSpeechRecognition'in window)){ alert("Tu navegador no soporta voz"); return; }
  const rec=new webkitSpeechRecognition();
  rec.lang='es-ES'; rec.start();
  rec.onresult=(e)=>{
    const cmd=e.results[0][0].transcript.toLowerCase();
    console.log("Comando:",cmd);
    if(cmd.includes("abrir mano")) openHand();
    else if(cmd.includes("cerrar mano")) closeHand();
    else if(cmd.includes("pausa")) pauseAll();
    else{
      for(let i=0;i<5;i++){
        const name=fingerNames[i].toLowerCase();
        if(cmd.includes(name)){
          const num=parseInt(cmd.match(/\d+/));
          if(!isNaN(num)&&num>=0&&num<=90){
            let targets=[...positions];
            targets[i]=num;
            gradualMove(targets);
          }
        }
      }
    }
  };
  rec.onerror=()=>alert("Error en reconocimiento");
}
</script>
</body>
</html>
