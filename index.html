<script>
const esp32IP = "http://172.19.123.247"; // ← Cambia esto con la IP real que te da el ESP32
const fingerNames = ["Meñique","Anular","Corazón","Índice","Pulgar"];
let positions = [90,90,90,90,90];
let lastSaved = [90,90,90,90,90];
let intervals = [null,null,null,null,null];  
const slidersDiv = document.getElementById('sliders');

for(let i=0;i<5;i++){
  const cont = document.createElement('div');
  cont.className = 'finger';
  cont.innerHTML = `
    <label>${fingerNames[i]} — <span class="value" id="val${i}">${positions[i]}</span>°</label>
    <button class="step-btn" onclick="stepFinger(${i},-1)">◀</button>
    <input type="range" min="0" max="90" value="${positions[i]}" id="s${i}" oninput="manualMove(${i},this.value)">
    <button class="step-btn" onclick="stepFinger(${i},1)">▶</button>
    <button class="hook-btn" onclick="regresarAnterior(${i})">↺</button>
    <button class="hook-btn" onclick="pauseFinger(${i})">⏸</button>
  `;
  slidersDiv.appendChild(cont);
}

// Manual inmediato (sin retraso)
function manualMove(idx,val){
  val=parseInt(val);
  positions[idx]=val;
  document.getElementById('val'+idx).textContent=val;
  document.getElementById('s'+idx).value=val;
  fetch(`${esp32IP}/servo?finger=${idx}&value=${val}`).catch(()=>{});
}

// Flechas 1° de movimiento manual inmediato
function stepFinger(idx,direction){
  let target = positions[idx] + direction;
  target = Math.max(0,Math.min(90,target));
  manualMove(idx,target);
}

// Pausar un dedo
function pauseFinger(idx){
  if(intervals[idx]) clearInterval(intervals[idx]);
  intervals[idx]=null;
}

// Abrir/Cerrar Mano todos
function startAll(angle){
  for(let i=0;i<5;i++) moveToAngle(i,angle);
}

// Regresar al anterior valor guardado
function regresarAnterior(idx){
  moveToAngle(idx,lastSaved[idx]);
}

// Movimiento gradual 3° cada 2s hasta target
function moveToAngle(idx,target){
  pauseFinger(idx);
  lastSaved[idx]=positions[idx]; 
  let current = positions[idx];
  let step = (target>current?3:-3);
  if(current===target) return;
  intervals[idx]=setInterval(()=>{
    current+=step;
    if((step>0 && current>=target) || (step<0 && current<=target)){
      current=target;
      clearInterval(intervals[idx]);
      intervals[idx]=null;
    }
    positions[idx]=current;
    document.getElementById('s'+idx).value=current;
    document.getElementById('val'+idx).textContent=current;
    fetch(`${esp32IP}/servo?finger=${idx}&value=${current}`).catch(()=>{});
  },2000);
}

