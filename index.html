<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Exoesqueleto de los Timbritos</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #0d1117;
    color: #e6eef6;
    text-align: center;
    margin: 0;
    padding: 0;
  }
  h1 {
    background: #06b6d4;
    color: #0d1117;
    padding: 10px;
    margin: 0;
  }
  .container {
    margin: 20px auto;
    max-width: 400px;
    background: #161b22;
    padding: 20px;
    border-radius: 10px;
  }
  .finger {
    margin: 15px 0;
    padding: 10px;
    border: 1px solid #06b6d4;
    border-radius: 8px;
  }
  .finger label {
    font-weight: bold;
    display: block;
    margin-bottom: 5px;
  }
  input[type=range] {
    width: 100%;
  }
  .value {
    font-size: 0.9em;
    color: #94a3b8;
  }
  .btn {
    margin: 8px;
    padding: 10px 15px;
    background: #06b6d4;
    border: none;
    color: #0d1117;
    border-radius: 8px;
    cursor: pointer;
    font-weight: bold;
  }
  .btn.secondary {
    background: transparent;
    border: 1px solid #06b6d4;
    color: #06b6d4;
  }
  .log {
    margin-top: 15px;
    background: #11161e;
    border-radius: 6px;
    padding: 10px;
    font-size: 0.9em;
    text-align: left;
    height: 100px;
    overflow-y: auto;
  }
  .controls {
    display: flex;
    justify-content: center;
    gap: 5px;
    margin-top: 5px;
  }
</style>
</head>
<body>

<h1>Exoesqueleto de los Timbritos</h1>

<div class="container" id="sliders"></div>

<div>
  <button class="btn" onclick="abrirMano()">Abrir Mano</button>
  <button class="btn" onclick="toggleVoice()">üéô Activar Voz</button>
  <button class="btn secondary" onclick="togglePauseVoice()">‚è∏ Pausar Voz</button>
  <button class="btn secondary" onclick="abrirSelector()">‚è™ Regresar al Anterior</button>
</div>

<div class="log" id="log"></div>

<script>
const fingerNames = ["Me√±ique", "Anular", "Coraz√≥n", "√çndice", "Pulgar"];
let positions = [90, 90, 90, 90, 90];
let previousPositions = [...positions];
let paused = [false, false, false, false, false];
let recognition;
let voiceActive = false;
const slidersDiv = document.getElementById('sliders');
const logBox = document.getElementById('log');

/* ====== Crear sliders din√°micamente ====== */
for (let i = 0; i < 5; i++) {
  const cont = document.createElement('div');
  cont.className = 'finger';
  cont.innerHTML = `
    <label>${fingerNames[i]} ‚Äî <span class="value" id="val${i}">${positions[i]}¬∞</span></label>
    <div class="controls">
      <button onclick="ajustarDedo(${i}, -5)">‚óÄ</button>
      <input type="range" min="0" max="90" value="${positions[i]}" id="s${i}" oninput="onSliderInput(${i}, this.value)">
      <button onclick="ajustarDedo(${i}, 5)">‚ñ∂</button>
    </div>
  `;
  slidersDiv.appendChild(cont);
}

/* ====== Log visual ====== */
function log(msg) {
  logBox.innerHTML += msg + "<br>";
  logBox.scrollTop = logBox.scrollHeight;
}

/* ====== Slider manual ====== */
function onSliderInput(idx, val) {
  previousPositions[idx] = positions[idx];
  positions[idx] = parseInt(val);
  document.getElementById('val' + idx).textContent = val + '¬∞';
  fetch(`/servo?finger=${idx}&value=${val}`).catch(()=>{});
}

/* ====== Botones de ajuste por pasos ====== */
function ajustarDedo(idx, step) {
  let newPos = Math.max(0, Math.min(90, positions[idx] + step));
  previousPositions[idx] = positions[idx];
  positions[idx] = newPos;
  document.getElementById('s' + idx).value = newPos;
  document.getElementById('val' + idx).textContent = newPos + '¬∞';
  fetch(`/servo?finger=${idx}&value=${newPos}`).catch(()=>{});
}

/* ====== Regresar al anterior ====== */
function abrirSelector() {
  let opt = prompt("Selecciona dedo: 0=Me√±ique, 1=Anular, 2=Coraz√≥n, 3=√çndice, 4=Pulgar");
  if(opt !== null) {
    opt = parseInt(opt);
    if(opt>=0 && opt<5){
      let prev = previousPositions[opt];
      positions[opt] = prev;
      document.getElementById('s'+opt).value = prev;
      document.getElementById('val'+opt).textContent = prev + '¬∞';
      fetch(`/servo?finger=${opt}&value=${prev}`).catch(()=>{});
      log(`‚Ü© ${fingerNames[opt]} regres√≥ a ${prev}¬∞`);
    }
  }
}

/* ====== Movimiento suave ====== */
async function moverSuave(idx, destino) {
  while(positions[idx] !== destino && !paused[idx]) {
    let step = (destino > positions[idx]) ? 5 : -5;
    positions[idx] = Math.max(0, Math.min(90, positions[idx] + step));
    document.getElementById('s'+idx).value = positions[idx];
    document.getElementById('val'+idx).textContent = positions[idx] + '¬∞';
    fetch(`/servo?finger=${idx}&value=${positions[idx]}`).catch(()=>{});
    await new Promise(r => setTimeout(r, 2000));
  }
}

/* ====== Abrir mano completa ====== */
function abrirMano() {
  log("üñê Abriendo toda la mano...");
  for(let i=0;i<5;i++) moverSuave(i, 90);
}

/* ====== Reconocimiento de voz continuo ====== */
function toggleVoice() {
  if(!('webkitSpeechRecognition' in window)){
    alert("Tu navegador no soporta reconocimiento de voz");
    return;
  }
  if(voiceActive) {
    log("üéô El reconocimiento ya est√° activo.");
    return;
  }
  recognition = new webkitSpeechRecognition();
  recognition.lang = "es-ES";
  recognition.continuous = true;
  recognition.interimResults = false;

  recognition.onstart = ()=> {
    voiceActive = true;
    log("üé§ Reconocimiento de voz activado...");
  };
  recognition.onresult = e=>{
    let cmd = e.results[e.results.length - 1][0].transcript.toLowerCase();
    log("üó£ Comando: " + cmd);
    procesarComando(cmd);
  };
  recognition.onerror = e=> log("‚ö† Error: " + e.error);
  recognition.onend = ()=> {
    if(voiceActive) recognition.start(); // reiniciar autom√°ticamente
  };
  recognition.start();
}

/* ====== Pausar reconocimiento ====== */
function togglePauseVoice() {
  if(voiceActive && recognition) {
    recognition.stop();
    voiceActive = false;
    log("‚è∏ Voz pausada manualmente.");
  } else {
    toggleVoice();
  }
}

/* ====== Procesar comandos de voz ====== */
function procesarComando(cmd){
  if(cmd.includes("abrir mano")) {
    log("ü§ñ Abriendo toda la mano...");
    for(let i=0;i<5;i++) moverSuave(i,90);
  }
  else if(cmd.includes("cerrar mano")) {
    log("ü§ñ Cerrando toda la mano...");
    for(let i=0;i<5;i++) moverSuave(i,0);
  }
  else if(cmd.includes("pausar")) {
    fingerNames.forEach((f,idx)=>{
      if(cmd.includes(f.toLowerCase())) {
        paused[idx] = true;
        log(`‚è∏ ${f} pausado.`);
      }
    });
    if(!cmd.match(/me√±ique|anular|coraz√≥n|√≠ndice|pulgar/)) {
      paused = [true,true,true,true,true];
      log("‚è∏ Todos los dedos pausados.");
    }
  } else {
    fingerNames.forEach((f,idx)=>{
      if(cmd.includes(f.toLowerCase())){
        let match = cmd.match(/\d+/);
        if(match){
          let destino = parseInt(match[0]);
          paused[idx]=false;
          log(`‚û° Moviendo ${f} a ${destino}¬∞`);
          moverSuave(idx, destino);
        }
      }
    });
  }
}
</script>
</body>
</html>
