<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Control Mano Rob√≥tica</title>
<style>
body{font-family:Arial;background:#0d1117;color:#e6eef6;text-align:center;margin:0;padding:0;}
h1{background:#06b6d4;color:#0d1117;padding:10px;margin:0;}
.container{margin:20px auto;max-width:400px;background:#161b22;padding:20px;border-radius:10px;}
.finger{margin:15px 0;padding:10px;border:1px solid #06b6d4;border-radius:8px;display:flex;align-items:center;justify-content:space-between;}
.finger label{font-weight:bold;display:block;margin-bottom:5px;flex:1;}
input[type=range]{width:70%;}
.value{font-size:0.9em;color:#94a3b8;margin-left:10px;}
.btn{margin:8px;padding:10px 15px;background:#06b6d4;border:none;color:#0d1117;border-radius:8px;cursor:pointer;font-weight:bold;}
.btn.secondary{background:transparent;border:1px solid #06b6d4;color:#06b6d4;}
.arrow-btn{margin-left:5px;margin-right:5px;padding:4px 8px;font-weight:bold;border-radius:5px;border:none;background:#06b6d4;color:#0d1117;cursor:pointer;}
</style>
</head>
<body>
<h1>Control Mano Rob√≥tica</h1>

<div class="container" id="sliders"></div>

<div>
  <button class="btn" onclick="slowMove('open')">Abrir Mano</button>
  <button class="btn" onclick="slowMove('close')">Cerrar Mano</button>
  <button class="btn secondary" onclick="slowMove('reset')">Ajustar inicio</button>
  <button class="btn" onclick="pauseMove()">‚è∏ Pausar</button>
  <button class="btn" id="start">üé§ Voz</button>
</div>

<div id="status" style="margin-top:15px;">Presiona "Voz" y di abrir o cerrar</div>

<script>
const ESP32_IP = "192.168.0.105"; // <-- cambia por la IP real del ESP32
const fingerNames = ["me√±ique","anular","coraz√≥n","√≠ndice","pulgar"];
let positions = [90,90,90,90,90];
const slidersDiv = document.getElementById('sliders');
const status = document.getElementById('status');
let moving = false;
let paused = false;

/* enviar valor a ESP32 */
function sendServo(idx, val){
  if(idx==2||idx==3) val = 90 - val; // invertir coraz√≥n e √≠ndice
  fetch(`http://${ESP32_IP}/servo?finger=${idx}&value=${val}`).catch(()=>{});
}

/* crear sliders */
for(let i=0;i<5;i++){
  const cont = document.createElement('div');
  cont.className = 'finger';
  cont.innerHTML = `
    <label>${fingerNames[i]} ‚Äî <span class="value" id="val${i}">${positions[i]}¬∞</span></label>
    <button class="arrow-btn" onclick="adjustSlider(${i},-1)">‚óÄ</button>
    <input type="range" min="0" max="90" value="${positions[i]}" id="s${i}" oninput="onSliderInput(${i},this.value)">
    <button class="arrow-btn" onclick="adjustSlider(${i},1)">‚ñ∂</button>
  `;
  slidersDiv.appendChild(cont);
}

/* slider manual */
function onSliderInput(idx,val){
  val=parseInt(val);
  positions[idx]=val;
  document.getElementById('val'+idx).textContent=val+'¬∞';
  sendServo(idx,val);
}

/* ajuste con flechas */
function adjustSlider(idx,delta){
  let val=positions[idx]+delta;
  if(val<0) val=0;
  if(val>90) val=90;
  positions[idx]=val;
  document.getElementById('s'+idx).value=val;
  document.getElementById('val'+idx).textContent=val+'¬∞';
  sendServo(idx,val);
}

/* pausa */
function pauseMove(){
  paused = true;
  moving = false;
  status.innerText = "‚è∏ Movimiento pausado";
}

/* movimiento completo o individual */
function slowMove(action, fingerIndex=null, targetValue=null){
  if(moving){ status.innerText="Movimiento en curso..."; return; }
  moving=true;
  paused=false;
  let target=[];
  if(action==='open') target=[90,90,90,90,90];
  if(action==='close') target=[0,0,0,0,0];
  if(action==='reset') target=[90,90,90,90,90];
  if(action==='single') target = positions.slice();

  if(action==='single' && fingerIndex!==null && targetValue!==null){
    target[fingerIndex]=targetValue;
  }

  status.innerText = (action==='open') ? "üñê Abriendo mano..." :
                     (action==='close') ? "‚úä Cerrando mano..." :
                     (action==='reset') ? "üîÑ Ajustando inicio..." :
                     "Moviendo dedo...";
  stepMove(target,action,fingerIndex);
}

function stepMove(target,action,fingerIndex){
  if(paused){ moving=false; return; }

  let done=true;
  for(let i=0;i<5;i++){
    if(action==='single' && i!==fingerIndex) continue;
    let current=positions[i];
    if(current<target[i]){
      positions[i]=Math.min(current+2,target[i]);
      done=false;
    } else if(current>target[i]){
      positions[i]=Math.max(current-2,target[i]);
      done=false;
    }
    document.getElementById('s'+i).value=positions[i];
    document.getElementById('val'+i).textContent=positions[i]+'¬∞';
    sendServo(i,positions[i]);
  }

  if(done){
    moving=false;
    if(action==='open') status.innerText="üñê Mano abierta";
    else if(action==='close') status.innerText="‚úä Mano cerrada";
    else if(action==='reset') status.innerText="‚úÖ Ajuste completado";
    else status.innerText="‚úÖ Movimiento finalizado";
    return;
  }
  setTimeout(()=>stepMove(target,action,fingerIndex),2000);
}

/* reconocimiento de voz */
document.getElementById('start').addEventListener('click',()=>{
  if(!('webkitSpeechRecognition' in window)){
    status.innerText="Tu navegador no soporta voz";
    return;
  }
  const rec=new webkitSpeechRecognition();
  rec.lang="es-ES";
  rec.interimResults=false;
  rec.maxAlternatives=1;
  rec.start();
  status.innerText="üéô Escuchando...";
  rec.onresult=function(e){
    const cmd=e.results[0][0].transcript.toLowerCase();
    status.innerText="Comando: "+cmd;

    if(cmd.includes("pausa")) pauseMove();
    else if(cmd.includes("abrir mano")) slowMove('open');
    else if(cmd.includes("cerrar mano")) slowMove('close');
    else {
      for(let i=0;i<fingerNames.length;i++){
        if(cmd.includes(fingerNames[i])){
          if(cmd.includes("abrir")) slowMove('single',i,90);
          else if(cmd.includes("cerrar")) slowMove('single',i,0);
          else {
            const num = cmd.match(/\d+/);
            if(num){
              let val=parseInt(num[0]);
              if(val<0) val=0;
              if(val>90) val=90;
              slowMove('single',i,val);
            }
          }
          return;
        }
      }
      status.innerText="Comando no reconocido";
    }
  };
  rec.onerror=function(e){status.innerText="Error: "+e.error;}
});
</script>
</body>
</html>
