<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Exoesqueleto de los Timbritos</title>
<style>
body { font-family: Arial, sans-serif; background: #0d1117; color: #e6eef6; text-align: center; margin: 0; padding: 0; }
h1 { background: #06b6d4; color: #0d1117; padding: 15px; font-size: 2em; margin: 0; }
.container { margin: 20px auto; max-width: 500px; background: #161b22; padding: 25px; border-radius: 12px; }
.finger { margin: 20px 0; padding: 10px; border: 2px solid #06b6d4; border-radius: 10px; display: flex; align-items: center; justify-content: space-between; font-size: 1.2em; }
.finger label { font-weight: bold; display: block; width: 50%; text-align: left; }
input[type=range] { width: 55%; height: 18px; }
.value { font-size: 1em; color: #94a3b8; width: 40px; display: inline-block; text-align: right; }
.btn { margin: 8px; padding: 12px 20px; background: #06b6d4; border: none; color: #0d1117; border-radius: 10px; cursor: pointer; font-weight: bold; font-size: 1.1em; }
.btn.secondary { background: transparent; border: 2px solid #06b6d4; color: #06b6d4; }
.control-buttons { margin-top: 15px; }
.mic-button { margin: 12px; padding: 15px; background: #facc15; border: none; border-radius: 50%; cursor: pointer; font-weight: bold; font-size: 1.4em; }
#commandBox { margin-top:15px; font-size: 1.2em; color: #facc15; min-height: 24px; }
.hook-btn, .step-btn { margin-left: 8px; padding: 6px 10px; font-size: 1em; cursor: pointer; border-radius: 6px; border: 2px solid #06b6d4; background: transparent; color: #06b6d4; }
</style>
</head>
<body>

<h1>Exoesqueleto de los Timbritos</h1>

<div class="container" id="sliders"></div>

<div class="control-buttons">
  <button class="btn" onclick="startAll(90)">Abrir Mano</button>
  <button class="btn" onclick="startAll(0)">Cerrar Mano</button>
</div>

<button class="mic-button" onclick="startVoice()">üé§</button>
<div id="commandBox"></div>

<script>
const fingerNames = ["Me√±ique","Anular","Coraz√≥n","√çndice","Pulgar"];
let positions = [90,90,90,90,90];
let lastSaved = [90,90,90,90,90];
let intervals = [null,null,null,null,null];  
const slidersDiv = document.getElementById('sliders');

// === IP del ESP32 ===
const ESP_IP = "192.168.4.10";  // ‚ö†Ô∏è CAMBIA ESTA IP por la de tu ESP32

for(let i=0;i<5;i++){
  const cont = document.createElement('div');
  cont.className = 'finger';
  cont.innerHTML = `
    <label>${fingerNames[i]} ‚Äî <span class="value" id="val${i}">${positions[i]}</span>¬∞</label>
    <button class="step-btn" onclick="stepFinger(${i},-1)">‚óÄ</button>
    <input type="range" min="0" max="90" value="${positions[i]}" id="s${i}" oninput="manualMove(${i},this.value)">
    <button class="step-btn" onclick="stepFinger(${i},1)">‚ñ∂</button>
    <button class="hook-btn" onclick="regresarAnterior(${i})">‚Ü∫</button>
    <button class="hook-btn" onclick="pauseFinger(${i})">‚è∏</button>
  `;
  slidersDiv.appendChild(cont);
}

// Manual inmediato (sin retraso)
function manualMove(idx,val){
  val=parseInt(val);
  positions[idx]=val;
  document.getElementById('val'+idx).textContent=val;
  document.getElementById('s'+idx).value=val;
  fetch(`${ESP_IP}/servo?finger=${idx}&value=${val}`).catch(()=>{});
}

// Flechas 1¬∞ de movimiento manual inmediato
function stepFinger(idx,direction){
  let target = positions[idx] + direction;
  target = Math.max(0,Math.min(90,target));
  manualMove(idx,target);
}

// Pausar un dedo
function pauseFinger(idx){
  if(intervals[idx]) clearInterval(intervals[idx]);
  intervals[idx]=null;
}

// Abrir/Cerrar Mano todos
function startAll(angle){
  for(let i=0;i<5;i++) moveToAngle(i,angle);
}

// Regresar al anterior valor guardado
function regresarAnterior(idx){
  moveToAngle(idx,lastSaved[idx]);
}

// Movimiento gradual 3¬∞ cada 2s hasta target
function moveToAngle(idx,target){
  pauseFinger(idx);
  lastSaved[idx]=positions[idx]; 
  let current = positions[idx];
  let step = (target>current?3:-3);
  if(current===target) return;
  intervals[idx]=setInterval(()=>{
    current+=step;
    if((step>0 && current>=target) || (step<0 && current<=target)){
      current=target;
      clearInterval(intervals[idx]);
      intervals[idx]=null;
    }
    positions[idx]=current;
    document.getElementById('s'+idx).value=current;
    document.getElementById('val'+idx).textContent=current;
    fetch(`${ESP_IP}/servo?finger=${idx}&value=${current}`).catch(()=>{});
  },2000);
}

// ===== Comando de voz =====
function startVoice(){
  const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
  recognition.lang='es-ES';
  recognition.start();
  recognition.onresult=function(event){
    let text=event.results[0][0].transcript.toLowerCase().trim();
    document.getElementById('commandBox').textContent='Comando detectado: '+text;

    if(text.includes('pausar')){
      for(let i=0;i<5;i++){
        let name=fingerNames[i].toLowerCase();
        if(text.includes(name)) pauseFinger(i);
      }
      return;
    }

    if(text.includes('abrir mano')) startAll(90);
    else if(text.includes('cerrar mano')) startAll(0);
    else{
      for(let i=0;i<5;i++){
        let name=fingerNames[i].toLowerCase();
        if(text.includes(name) && text.match(/\d+/)){
          let val=parseInt(text.match(/\d+/)[0]);
          val=Math.min(Math.max(0,val),90);
          moveToAngle(i,val);
        }
      }
    }
  };
  recognition.onerror=function(e){ console.log('Error reconocimiento',e); };
}
</script>
</body>
</html>

